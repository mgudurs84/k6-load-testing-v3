# CDR Pulse K6 Load Test - GitHub Actions Workflow Template
# 
# This workflow accepts dynamic test configuration from CDR Pulse dashboard
# and executes K6 load tests with the specified parameters.
#
# Setup Instructions:
# 1. Copy this file to your repository at: .github/workflows/load-test.yml
# 2. Ensure your repository has K6 access (the workflow installs it automatically)
# 3. Configure CDR Pulse to point to your repository
#
# How It Works:
# - CDR Pulse calls the GitHub Actions API to trigger this workflow
# - Test configuration (APIs, payloads, thresholds) is passed as workflow inputs
# - The workflow generates a K6 script from the configuration
# - K6 runs the test and uploads results as artifacts
# - CDR Pulse fetches the artifacts to display results

name: CDR Pulse K6 Load Test

on:
  workflow_dispatch:
    inputs:
      test_id:
        description: 'Unique test identifier (generated by CDR Pulse)'
        required: true
        type: string
      
      virtual_users:
        description: 'Target number of virtual users'
        required: true
        default: '100'
      
      duration:
        description: 'Test duration (e.g., 5m, 30s, 1h)'
        required: true
        default: '5m'
      
      ramp_up:
        description: 'Ramp-up time (e.g., 30s, 1m, 2m)'
        required: true
        default: '30s'
      
      ramp_down:
        description: 'Ramp-down time'
        required: false
        default: '30s'
      
      response_threshold_ms:
        description: 'Max p95 response time in milliseconds'
        required: true
        default: '500'
      
      error_threshold_percent:
        description: 'Max error rate percentage (1 = 1%)'
        required: true
        default: '1'
      
      endpoints_json:
        description: 'JSON array of API endpoints to test'
        required: true
        type: string
      
      payloads_base64:
        description: 'Base64-encoded JSON payload data (optional)'
        required: false
        type: string
      
      base_url:
        description: 'Base URL for API endpoints'
        required: true
        type: string

jobs:
  load-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Log Test Configuration
        run: |
          echo "=== CDR Pulse Load Test Configuration ==="
          echo "Test ID: ${{ inputs.test_id }}"
          echo "Virtual Users: ${{ inputs.virtual_users }}"
          echo "Duration: ${{ inputs.duration }}"
          echo "Ramp Up: ${{ inputs.ramp_up }}"
          echo "Base URL: ${{ inputs.base_url }}"
          echo "Response Threshold: ${{ inputs.response_threshold_ms }}ms"
          echo "Error Threshold: ${{ inputs.error_threshold_percent }}%"
      
      - name: Decode Payloads
        id: payloads
        run: |
          if [ -n "${{ inputs.payloads_base64 }}" ]; then
            echo "${{ inputs.payloads_base64 }}" | base64 -d > payloads.json
            echo "has_payloads=true" >> $GITHUB_OUTPUT
            echo "Payloads decoded successfully"
          else
            echo "{}" > payloads.json
            echo "has_payloads=false" >> $GITHUB_OUTPUT
            echo "No payloads provided"
          fi
      
      - name: Generate K6 Script
        run: |
          cat > k6-test.js << 'SCRIPT_EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          import { Counter, Rate, Trend } from 'k6/metrics';
          
          // Custom metrics for detailed analysis
          const requestDuration = new Trend('request_duration_custom');
          const requestErrors = new Rate('request_errors');
          const requestCount = new Counter('request_count');
          
          // Configuration from CDR Pulse
          const BASE_URL = '${{ inputs.base_url }}';
          const ENDPOINTS = ${{ inputs.endpoints_json }};
          
          // Load payloads if provided
          let PAYLOADS = {};
          try {
            PAYLOADS = JSON.parse(open('./payloads.json'));
          } catch (e) {
            console.log('No payloads file or invalid format');
          }
          
          export const options = {
            stages: [
              { duration: '${{ inputs.ramp_up }}', target: ${{ inputs.virtual_users }} },
              { duration: '${{ inputs.duration }}', target: ${{ inputs.virtual_users }} },
              { duration: '${{ inputs.ramp_down }}', target: 0 },
            ],
            thresholds: {
              http_req_duration: ['p(95)<${{ inputs.response_threshold_ms }}'],
              http_req_failed: ['rate<0.0${{ inputs.error_threshold_percent }}'],
              request_errors: ['rate<0.0${{ inputs.error_threshold_percent }}'],
            },
          };
          
          function getRandomPayload(endpointId) {
            const endpointPayloads = PAYLOADS[endpointId] || [];
            if (endpointPayloads.length === 0) return null;
            return endpointPayloads[Math.floor(Math.random() * endpointPayloads.length)];
          }
          
          function makeRequest(endpoint) {
            const url = BASE_URL + endpoint.path;
            const method = endpoint.method.toUpperCase();
            const headers = { 'Content-Type': 'application/json' };
            const payload = getRandomPayload(endpoint.id);
            
            let response;
            const startTime = Date.now();
            
            try {
              switch (method) {
                case 'POST':
                  response = http.post(url, payload ? JSON.stringify(payload) : null, { headers });
                  break;
                case 'PUT':
                  response = http.put(url, payload ? JSON.stringify(payload) : null, { headers });
                  break;
                case 'PATCH':
                  response = http.patch(url, payload ? JSON.stringify(payload) : null, { headers });
                  break;
                case 'DELETE':
                  response = http.del(url, { headers });
                  break;
                case 'HEAD':
                  response = http.head(url, { headers });
                  break;
                case 'OPTIONS':
                  response = http.options(url, { headers });
                  break;
                default:
                  response = http.get(url, { headers });
              }
              
              const duration = Date.now() - startTime;
              requestDuration.add(duration);
              requestCount.add(1);
              
              const success = response.status >= 200 && response.status < 400;
              requestErrors.add(!success);
              
              check(response, {
                [`${endpoint.name || endpoint.path} status is 2xx/3xx`]: (r) => r.status >= 200 && r.status < 400,
                [`${endpoint.name || endpoint.path} response time < ${{ inputs.response_threshold_ms }}ms`]: () => duration < ${{ inputs.response_threshold_ms }},
              });
              
              return response;
            } catch (error) {
              requestErrors.add(1);
              console.error(`Request to ${url} failed: ${error}`);
              return null;
            }
          }
          
          export default function () {
            // Test each endpoint
            ENDPOINTS.forEach((endpoint) => {
              makeRequest(endpoint);
            });
            
            // Think time between iterations
            sleep(1);
          }
          
          export function handleSummary(data) {
            // Generate both JSON and human-readable output
            const summary = {
              testId: '${{ inputs.test_id }}',
              timestamp: new Date().toISOString(),
              configuration: {
                virtualUsers: ${{ inputs.virtual_users }},
                duration: '${{ inputs.duration }}',
                baseUrl: '${{ inputs.base_url }}',
                endpointCount: ENDPOINTS.length,
              },
              metrics: data.metrics,
              thresholds: data.root_group?.checks || {},
            };
            
            return {
              'results.json': JSON.stringify(summary, null, 2),
              stdout: generateTextSummary(data),
            };
          }
          
          function generateTextSummary(data) {
            const metrics = data.metrics;
            let output = '\n=== CDR Pulse K6 Load Test Summary ===\n\n';
            
            output += `Test ID: ${{ inputs.test_id }}\n`;
            output += `Duration: ${Math.round(data.state?.testRunDurationMs / 1000 || 0)}s\n`;
            output += `Virtual Users: ${{ inputs.virtual_users }}\n`;
            output += `Endpoints Tested: ${ENDPOINTS.length}\n\n`;
            
            if (metrics.http_req_duration) {
              output += `Response Times:\n`;
              output += `  - Avg: ${Math.round(metrics.http_req_duration.values.avg || 0)}ms\n`;
              output += `  - p95: ${Math.round(metrics.http_req_duration.values['p(95)'] || 0)}ms\n`;
              output += `  - p99: ${Math.round(metrics.http_req_duration.values['p(99)'] || 0)}ms\n\n`;
            }
            
            if (metrics.http_reqs) {
              output += `Requests: ${metrics.http_reqs.values.count || 0}\n`;
              output += `RPS: ${Math.round(metrics.http_reqs.values.rate || 0)}\n`;
            }
            
            if (metrics.http_req_failed) {
              output += `Error Rate: ${((metrics.http_req_failed.values.rate || 0) * 100).toFixed(2)}%\n`;
            }
            
            return output;
          }
          SCRIPT_EOF
          
          echo "K6 script generated successfully"
          echo "=== Script Content ==="
          head -50 k6-test.js
      
      - name: Install K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
          k6 version
      
      - name: Run K6 Load Test
        run: |
          echo "Starting K6 load test..."
          k6 run k6-test.js --out json=k6-output.json 2>&1 | tee k6-console.log
          echo "Load test completed"
        continue-on-error: true
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: k6-results-${{ inputs.test_id }}
          path: |
            results.json
            k6-output.json
            k6-console.log
            payloads.json
          retention-days: 30
      
      - name: Job Summary
        run: |
          echo "## K6 Load Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test ID:** ${{ inputs.test_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Virtual Users:** ${{ inputs.virtual_users }}" >> $GITHUB_STEP_SUMMARY
          echo "**Duration:** ${{ inputs.duration }}" >> $GITHUB_STEP_SUMMARY
          echo "**Base URL:** ${{ inputs.base_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Results are available in the artifacts section above." >> $GITHUB_STEP_SUMMARY
